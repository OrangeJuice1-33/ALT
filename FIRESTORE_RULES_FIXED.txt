# CORRECTED FIRESTORE SECURITY RULES

Copy and paste this into your Firebase Console → Firestore Database → Rules:

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Public read access for listings collection
    // Note: Application code filters out unapproved listings
    match /listings/{listingId} {
      allow read: if true;  // Allow public read (queries need this)
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
                       (request.auth.uid == resource.data.user_id || 
                        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin');
      allow delete: if request.auth != null && 
                       (request.auth.uid == resource.data.user_id || 
                        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Profiles collection
    match /profiles/{userId} {
      allow read: if request.auth != null && 
                     (request.auth.uid == userId || 
                      get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin');
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && 
                       (request.auth.uid == userId || 
                        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.user_id;
      allow delete: if request.auth != null && 
                       (request.auth.uid == resource.data.user_id || 
                        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin');
    }
  }
}
```

## Why `allow read: if true`?

When you use `getDocs(query(...))` to query a collection, Firestore evaluates the security rule for the QUERY itself, not individual documents. The query needs to be allowed before Firestore can return any documents.

Your application code already filters out unapproved listings:
```javascript
if (data.approved === false) {
  return; // Skip unapproved listings
}
```

So security is maintained at the application level - unapproved listings won't be displayed to users.

## Steps:
1. Copy the rules above
2. Go to Firebase Console → Firestore Database → Rules
3. Paste and replace existing rules
4. Click "Publish"
5. Wait a few seconds for deployment
6. Refresh your app
